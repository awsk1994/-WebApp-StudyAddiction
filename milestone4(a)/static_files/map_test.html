/*
TODO:
 - onClick (dialogs) for tables - for user to say if table is occupied or not
 - update database periodically via ajax
        -> send update to server whenever there is a change.
        -> server sends update to user whenever data has been changed

FILES required by this html:
 - data.json (for now - will fetch via HTTP later)
 - border_data.js (containing coordinate for library borders)
 */

<html>
<head>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <style>
        #map{ height:500px;}
    </style>
    <title> StudyAddicts </title>
    <script src="jquery-1.11.3.min.js"></script>
    <script src="border_data.js" type="text/javascript"></script>

     <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
     <script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />

    <script type="text/javascript">
        $(document).ready(function()
        {
            $(document).ajaxError(function()
            {
                alert("Sorry, there was a problem!");
            });

            //URL to get tile (image) from mapbox
            var mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiYXdzazE5OTQiLCJhIjoiY2loZjc4cjk1MDRja3RyajcxZzZ5MzcxbSJ9.E_JGHPNkZ5_nC6AtQGINjQ';

            //Set up layer for floor_1 and floor_2 [each with max and min zoom, and id (type of map to retrieve)]
            var floor_1 = new L.LayerGroup().addLayer(L.tileLayer(mbUrl, {
                    id: 'mapbox.streets',
                    maxZoom: 21,
                    minZoom: 16
                }));

            var floor_2 = new L.LayerGroup().addLayer(L.tileLayer(mbUrl, {
                    id: 'mapbox.streets',
                    maxZoom: 21,
                    minZoom: 16
                }));

            //Variable for baseLayer
            var baseLayers = {
                "floor_1": floor_1,
                "floor_2": floor_2,
            };

            //Variables for map boundaries.
            var topR = L.latLng(43.123, -77.6245),
                botL = L.latLng(43.133,-77.635);

            //Set up map
            //Default zoom is 20, center is set, and default layer is floor_1
            var map = L.map('map', 
            {
                center: [43.12505, -77.63],
                zoom: 20,
                maxBounds: L.latLngBounds(topR, botL),
                layers: [floor_1]
            });

            //Setup layer control.
            //We do not need overlays (2nd param, non-exclusive layers)
            L.control.layers(baseLayers,{}, 
                {
                    //Position UI to change layer on top right.
                    position: 'topright',
                    collapsed: false
                }
            ).addTo(map);

            //For each feature in our layer, we want it to have a pop-up message to indicate information for user.
            function onEachFeature(feature, layer) 
            {
                var popupContent = "";
                console.log(feature);

                if (feature.properties && feature.properties.popupContent) 
                {
                    popupContent = feature.properties.popupContent;
                }

                layer.bindPopup(feature.properties.popupContent);
            };

            //Load floor_1 and floor_2's border.
            L.geoJson(floor1_border,
            {
                style: function (feature)
                {
                    return feature.properties && feature.properties.style;
                } 
            }).addTo(floor_1);

            L.geoJson(floor2_border,
            {
                style: function (feature)
                {
                    return feature.properties && feature.properties.style;
                } 
            }).addTo(floor_2);

            //Get (local - for now) coordinates from json file and load it onto the map.
            $.getJSON("data.json", function(tables)
            {
                L.geoJson(tables, 
                {
                    /*
                    style: function (feature)
                    {
                        return feature.properties && feature.properties.style;
                    },*/
                    onEachFeature: onEachFeature,
                    pointToLayer: function (feature, latlng) 
                    {
                        //Set up rectangle for the tables.
                        var offset = 0.000008;
                        var bounds = [
                        [feature.geometry.coordinates[0]-(offset), 
                            feature.geometry.coordinates[1]-offset],

                        [feature.geometry.coordinates[0]+(offset), 
                            feature.geometry.coordinates[1]+offset]
                                ];
                                console.log(bounds);

                        //Set color based on occupied flag
                        var color_free = "#53d769";
                        var color_occupied = "#ff0000";
                        var color_error = "3c3636";
                        var color = "";

                        if(feature.occupied == 0)
                            color = color_free;
                        else if(feature.occupied == 1)
                            color = color_occupied;
                        else
                            color = color_error;

                        //Add the tables to its respective layers.
                        if(feature.level == 1)
                        {
                            return L.rectangle(bounds,
                            {
                                color: color, 
                                weight: 2
                            }).addTo(floor_1);
                        }
                        else if (feature.level == 2)
                        {
                            return L.rectangle(bounds,
                            {
                                color: color, 
                                weight: 2
                            }).addTo(floor_2);
                        }
                        else
                        {
                            return L.rectangle(bounds,
                            {
                                color: color_error, 
                                weight: 2
                            });
                        }
                    }
                });

                console.log("OK");
            });

        });
    </script>
</head>

<body>
    <h1>Map</h1>
    <div id="map"></div>
</body>